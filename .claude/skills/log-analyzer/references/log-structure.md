# Hook Log File Structure Reference

## Overview

Logs are generated by the `subagent-stop-hook` which captures the full transcript of each Claude Code sub-agent execution.

## File Naming Convention

```
{timestamp}_{topic}_{Step}_{scene}.log
```

| Component | Format | Examples |
|-----------|--------|----------|
| timestamp | `YYYY-MM-DD_HH-MM-SS` | `2025-12-17_11-19-14` |
| topic | kebab-case identifier | `hypersonic-warfare-m9k3` |
| Step | Pipeline step name | `Direction`, `Assets`, `Design`, `Video` |
| scene | Scene identifier | `root`, `0`, `1`, ..., `9` |

## Pipeline Steps

| Step | Scene Pattern | Description |
|------|--------------|-------------|
| Direction | `root` | Single agent generates video direction for all scenes |
| Assets | `root` | Single agent generates all SVG assets |
| Design | `0`-`9` | One agent per scene, generates design specification |
| Video | `0`-`9` | One agent per scene, generates React component |

## JSON Structure

```json
{
  "hook_name": "subagent-stop-hook",
  "timestamp": "ISO8601 timestamp when log was created",
  "input": {
    "session_id": "UUID of the parent session",
    "transcript_path": "Path to parent session transcript",
    "cwd": "Working directory",
    "permission_mode": "acceptEdits | ...",
    "hook_event_name": "SubagentStop",
    "stop_hook_active": false,
    "agent_id": "Short ID of this sub-agent",
    "agent_transcript_path": "Path to agent transcript file",
    "agent_transcript_data": [
      // Array of messages - see Message Structure below
    ]
  }
}
```

## Message Structure

### User Message
```json
{
  "parentUuid": "UUID of parent message",
  "isSidechain": true,
  "userType": "external",
  "cwd": "Working directory",
  "sessionId": "Session UUID",
  "version": "Claude Code version",
  "gitBranch": "Current git branch",
  "agentId": "Agent short ID",
  "slug": "Human-readable session slug",
  "type": "user",
  "message": {
    "role": "user",
    "content": "String or array of content blocks"
  },
  "uuid": "Message UUID",
  "timestamp": "ISO8601 timestamp"
}
```

### Tool Result (in User Message)
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [
      {
        "tool_use_id": "ID from tool_use",
        "type": "tool_result",
        "content": "Result string or object",
        "is_error": false
      }
    ]
  },
  "toolUseResult": {
    "stdout": "Standard output",
    "stderr": "Standard error",
    "interrupted": false,
    "isImage": false
  }
}
```

### Assistant Message
```json
{
  "parentUuid": "UUID of parent message",
  "type": "assistant",
  "message": {
    "model": "claude-sonnet-4-5-20250929",
    "id": "Message ID from API",
    "type": "message",
    "role": "assistant",
    "content": [
      // Array of content blocks - see Content Blocks below
    ],
    "stop_reason": "tool_use | end_turn | null",
    "stop_sequence": null,
    "usage": {
      "input_tokens": 123,
      "cache_creation_input_tokens": 456,
      "cache_read_input_tokens": 789,
      "cache_creation": {
        "ephemeral_5m_input_tokens": 456,
        "ephemeral_1h_input_tokens": 0
      },
      "output_tokens": 100,
      "service_tier": "standard"
    }
  },
  "requestId": "API request ID",
  "uuid": "Message UUID",
  "timestamp": "ISO8601 timestamp"
}
```

## Content Blocks

### Text Block
```json
{
  "type": "text",
  "text": "The assistant's text response..."
}
```

### Tool Use Block
```json
{
  "type": "tool_use",
  "id": "toolu_01ABC...",
  "name": "Bash",
  "input": {
    "command": "...",
    "description": "..."
  }
}
```

Common tools:
- `Bash` - Shell command execution
- `Read` - File reading
- `Write` - File writing
- `Edit` - File editing
- `Glob` - File pattern matching
- `Grep` - Content searching
- `mcp__video_gen_tools__search_icons` - Icon search
- `mcp__video_gen_tools__get_icon` - Icon retrieval

## Token Usage Fields

| Field | Description |
|-------|-------------|
| `input_tokens` | Tokens in the prompt |
| `output_tokens` | Tokens in the response |
| `cache_creation_input_tokens` | Tokens written to prompt cache |
| `cache_read_input_tokens` | Tokens served from prompt cache |

**Cache efficiency calculation:**
```
cache_hit_rate = cache_read_input_tokens / (cache_read_input_tokens + input_tokens + cache_creation_input_tokens)
```

## Completion Markers

Successful completion:
```
AGENT COMPLETED RUNNING
- Status: success
```

Failed completion:
```
AGENT COMPLETED RUNNING
- Status: failed
```

## Error Detection

1. **Explicit errors**: `is_error: true` in tool_result
2. **Error patterns in content**: Look for:
   - `error`, `Error`, `ERROR`
   - `failed`, `Failed`, `FAILED`
   - `exception`, `Exception`
   - `traceback`, `Traceback`

## Analysis Tips

1. **Large files**: Log files can be 100KB-600KB because they contain full file contents that agents read/wrote. Extract metadata only.

2. **Parallel execution**: Design and Video steps run in parallel (scenes 0-9). Direction and Assets run as single agents.

3. **Retries**: Same step+scene with multiple timestamps indicates retries. Compare token usage and errors.

4. **Common issues**:
   - Schema validation failures in Design step
   - TSX syntax errors in Video step
   - Missing assets in Video step
   - Path resolution errors in any step
